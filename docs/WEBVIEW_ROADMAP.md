# WebView GUI Implementation Roadmap

This document outlines the high-level plan for integrating WebView-based GUI support into Beamer.

## Overview

Beamer will support modern web-based plugin interfaces using platform-native WebView components. The implementation follows a phased approach, starting with core platforms (macOS/Windows) and expanding to Linux and advanced features.

## Design Principles

- **Platform-native APIs**: Use OS-provided WebView components (no bundled browser)
- **Zero runtime overhead**: WebView only created when editor is opened
- **Progressive enhancement**: Plugins work without GUI, GUI is optional
- **Developer-friendly**: Support both embedded assets and dev server for hot reload

## Architecture Approach

### Direct Platform APIs vs Abstraction Libraries

**Decision**: Use direct platform APIs rather than cross-platform wrappers like `wry`.

**Rationale**:
- VST3 requires attaching to host-provided window handles (`NSView*`, `HWND`)
- `wry` is designed for Tauri apps that own the window lifecycle
- Direct APIs provide better control and avoid unnecessary abstraction layers
- Each platform gets optimal, native implementation

### Platform Implementation Strategy

| Platform | WebView Backend | Rust Crate | Status |
|----------|----------------|------------|--------|
| **macOS** | WKWebView | `icrate` + `objc2` | Phase 1 |
| **Windows** | WebView2 (Edge) | `windows` | Phase 1 |
| **Linux** | *(Deferred)* | TBD | Phase 3 |

**Linux Strategy**: Deferred due to GTK shared library conflicts in plugin bundles. Phase 3 will evaluate:
1. IPC-isolated UI process (cleanest, more complex)
2. WebKitGTK with documented version requirements
3. No GUI on Linux (many commercial plugins ship this way)

## Phased Implementation

### Phase 1: Core Platform Support (macOS/Windows)
**Goal**: Get WebView windows showing in plugins on macOS and Windows.

**Deliverables**:
- `IPlugView` implementation for macOS and Windows
- Platform-specific WebView creation and lifecycle management
- Static HTML loading (embedded assets)
- Integration with `EditorDelegate` trait
- Working example plugin with simple WebView UI

**Timeline**: Foundation phase - establishes architecture for all future work.

### Phase 2: Resource Loading & Developer Experience
**Goal**: Make WebView development productive and distributable.

**Deliverables**:
- Embedded asset system (`include_str!()` for HTML/CSS/JS)
- Dev server support (e.g., `http://localhost:3000` for hot reload)
- Asset bundling utilities
- Build tooling integration (`cargo xtask`)
- Documentation and examples

**Timeline**: Follows Phase 1, enables real-world plugin development.

### Phase 3: IPC & Parameter Binding
**Goal**: Bidirectional communication between Rust and JavaScript.

**Deliverables**:
- JavaScript API (`window.__BEAMER__` or similar)
- Invoke pattern: JS → Rust commands
- Event emission: Rust → JS updates
- Parameter change notification system
- Automatic parameter synchronization helpers
- Example plugins demonstrating IPC patterns

**Timeline**: Enables reactive UIs and complex interactions.

### Phase 4: Linux Support
**Goal**: Evaluate and implement Linux GUI support.

**Deliverables**:
- Analysis of GTK conflict mitigation strategies
- Chosen approach implementation (IPC vs WebKitGTK)
- Linux-specific documentation
- Cross-platform testing

**Timeline**: After core functionality proven on macOS/Windows.

## Technical Architecture

### Component Structure

```
crates/
├── beamer-webview/           # New crate (Phase 1)
│   ├── src/
│   │   ├── lib.rs            # Public API
│   │   ├── platform/
│   │   │   ├── macos.rs      # WKWebView implementation
│   │   │   ├── windows.rs    # WebView2 implementation
│   │   │   └── linux.rs      # Future: GTK or IPC
│   │   ├── view.rs           # IPlugView wrapper
│   │   └── resources.rs      # Resource loading (Phase 2)
│   └── Cargo.toml
```

### Integration Points

1. **beamer-core**: `EditorDelegate` trait (already exists)
2. **beamer-vst3**: `Vst3Processor::createView()` returns `IPlugView` instance
3. **beamer-webview**: Platform-specific `IPlugView` implementations
4. **beamer**: Re-export public WebView API via `prelude`

### Threading Model

| Thread | Operations |
|--------|-----------|
| **UI Thread** | WebView creation, destruction, resize, IPC |
| **Audio Thread** | Unaffected, no WebView interaction |
| **Host Thread** | `createView()` called here, WebView attached in `IPlugView::attached()` |

### Resource Loading Strategy (Phase 2)

```rust
pub enum ResourceSource {
    /// Embedded in binary - for release builds
    /// Generated by build script from `ui/dist/`
    Embedded {
        index_html: &'static str,
        assets: &'static [(&'static str, &'static [u8])],
    },

    /// Directory on disk - for development
    /// Watches for changes, no rebuild needed
    Directory(PathBuf),

    /// Dev server URL - for hot reload during UI development
    /// Example: "http://localhost:5173" (Vite dev server)
    DevServer(String),
}
```

## Success Criteria

### Phase 1 Complete
- [ ] Plugin opens window with WebView on macOS
- [ ] Plugin opens window with WebView on Windows
- [ ] Window handles resize, close, reopen correctly
- [ ] No memory leaks or crashes
- [ ] Example plugin demonstrates basic usage

### Phase 2 Complete
- [ ] Assets can be embedded in plugin binary
- [ ] Dev server mode works for local development
- [ ] Documentation covers UI development workflow
- [ ] Build tools integrate WebView asset bundling

### Phase 3 Complete
- [ ] JavaScript can invoke Rust commands
- [ ] Rust can emit events to JavaScript
- [ ] Parameter changes sync automatically
- [ ] Example plugins show real-world IPC patterns
- [ ] Performance acceptable for realtime audio UIs

### Phase 4 Complete
- [ ] Linux support working with documented requirements
- [ ] All three platforms tested in major DAWs
- [ ] Cross-platform example plugin

## Non-Goals

- **Not building a UI framework**: Use React, Svelte, Vue, or vanilla JS
- **Not replacing VSTGUI alternatives**: Complement, don't compete with ImGui/egui
- **Not supporting CLAP/AU/AAX**: VST3 only (initially)
- **Not bundling Chromium**: Use OS-native WebViews only

## References

- [ARCHITECTURE.md](../ARCHITECTURE.md) - Overall Beamer architecture
- [REFERENCE.md](./REFERENCE.md) - API reference (includes EditorDelegate)
- [VST3 IPlugView Documentation](https://steinbergmedia.github.io/vst3_dev_portal/pages/Technical+Documentation/VST+Module+Architecture/IPlugView.html)
- [vstwebview project](https://github.com/rdaum/vstwebview) - Reference implementation
- [Linux Plugin Distribution Issues](https://gist.github.com/abique/4c1b9b40f3413f0df1591d2a7c760db4)

## Status

**Current Phase**: Planning
**Next Milestone**: Phase 1 kickoff - macOS WKWebView implementation

See [WEBVIEW_PHASE1.md](./WEBVIEW_PHASE1.md) for detailed Phase 1 implementation plan.
